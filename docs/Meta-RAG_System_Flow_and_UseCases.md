# Meta-RAG: 전체 시스템 흐름 및 주요 사용 사례

이 문서는 Meta-RAG 시스템의 전체 아키텍처 흐름(End-to-End Flow)과 주요 액터(Actor) 별 사용 사례(Use Case)를 설명하여 시스템에 대한 상위 레벨의 이해를 돕는 것을 목표로 합니다.

## 1. 핵심 아키텍처 요약

Meta-RAG는 **듀얼-패스(Dual-Path) 백엔드**와 **지능형 중앙 라우터(Intelligent Central Router)**를 핵심으로 하는 유연하고 확장 가능한 구조를 가집니다.

-   **중앙 라우터 (Cloudflare)**: 모든 요청의 관문으로, 보안, 인증 및 지능형 트래픽 라우팅을 담당합니다.
-   **패스 A (Simple & Fast)**: Cloud Run 기반의 단순화된 RAG 시스템으로, 빠르고 비용 효율적인 응답을 제공합니다.
-   **패스 B (Advanced & Scalable)**: Vertex AI 기반의 고성능 RAG 시스템으로, 복잡하고 깊이 있는 질문에 대한 고품질 응답을 제공합니다.

---

## 2. 주요 액터 (Actors)

-   **최종 사용자 (End-User)**: RAG 시스템에 질문하여 답변을 얻는 주체입니다. (예: 학생)
-   **개발자 (Developer)**: 시스템을 유지보수하고, 새로운 기능을 개발하며, 배포하는 주체입니다.

---

## 3. 주요 사용 사례 (Key Use Cases)

### 가. 사용 사례 1: 최종 사용자의 질문 및 답변 과정

-   **액터**: 최종 사용자
-   **목표**: 질문을 하고, 자신의 의도에 맞는 최적의 답변을 받는다.

**✅ 전체 흐름 (End-to-End Flow):**

1.  **로그인**: 사용자가 클라이언트 앱(웹/모바일)에서 로그인하고, 인증 토큰(**JWT**)을 발급받습니다.
2.  **질문 전송**: 사용자가 질문을 입력하고 API 서버로 전송합니다. 이 요청에는 `Authorization` 헤더에 JWT가 포함됩니다.
3.  **라우터 도착**: 요청이 최전방의 **Cloudflare 중앙 라우터**에 도착합니다.
4.  **사용자 인증**: 라우터는 JWT를 검증하여 인가된 사용자인지 확인합니다. (실패 시 `401 Unauthorized` 반환)
5.  **경로 결정**: 라우터는 사전에 정의된 로직(헤더, 쿼리 내용, 사용자 등급 등)에 따라 요청을 처리할 최적의 경로(패스 A 또는 패스 B)를 결정합니다.
6.  **백엔드 처리**:
    -   **패스 A로 라우팅된 경우**: Cloud Run 서비스가 요청을 받아, 내장된 FAISS와 `networkx` 모델을 사용해 답변을 생성합니다.
    -   **패스 B로 라우팅된 경우**: Cloud Run 오케스트레이터가 요청을 받아, **Vertex AI Matching Engine**과 **Vertex AI Endpoint(LLM)** 와의 **서비스 간 인증**을 거쳐 답변을 생성합니다.
7.  **답변 반환**: 생성된 답변이 역순으로 라우터를 거쳐 사용자에게 최종적으로 전달됩니다.

![System Flow Diagram](https://gist.github.com/assets/3687397/229a1953-9b73-43a2-a3b9-8915d938320c/raw/bf3291c183e05362c68b7c50a748a1113201f38c/meta-rag-flow.svg)

### 나. 사용 사례 2: 개발자의 새 버전 배포

-   **액터**: 개발자
-   **목표**: 새로운 기능이나 버그 수정 사항을 안전하고 신속하게 프로덕션 환경에 배포한다.

**✅ CI/CD 흐름 (CI/CD Flow):**

1.  **코드 푸시**: 개발자가 로컬에서 개발 및 테스트를 완료한 후, `main` 브랜치로 코드를 `git push` 합니다.
2.  **파이프라인 트리거**: GitHub Actions가 `push` 이벤트를 감지하고, `.github/workflows/ci.yml`에 정의된 CI/CD 파이프라인을 자동으로 시작합니다.
3.  **테스트 (CI)**: 파이프라인은 가상 환경에서 `pytest`를 실행하여 코드의 무결성을 검증합니다. 테스트 실패 시, 파이프라인은 중단되고 개발자에게 알림이 갑니다.
4.  **빌드**: 테스트가 성공하면, 파이프라인은 `Dockerfile`을 사용하여 프로젝트를 새 Docker 이미지로 빌드합니다. 이미지 태그에는 추적을 위해 Git Commit SHA가 사용됩니다.
5.  **이미지 푸시**: 빌드된 이미지를 GCP **Artifact Registry**에 업로드합니다.
6.  **배포 (CD)**: 파이프라인은 Cloud Run에 배포 명령을 내려, 방금 푸시된 새 이미지로 서비스를 업데이트합니다.
7.  **배포 완료**: 잠시 후, Cloud Run 서비스는 중단 없이 새 버전으로 전환되어 트래픽을 처리하기 시작합니다.

---

## 4. 결론

Meta-RAG 시스템은 최종 사용자와 개발자 모두를 위한 명확한 흐름을 가지고 있습니다. 사용자는 지능형 라우터를 통해 자신의 질문에 가장 적합한 답변을 받게 되며, 개발자는 GitHub Actions 기반의 자동화된 CI/CD 파이프라인을 통해 안정적으로 시스템을 개선하고 운영할 수 있습니다.
