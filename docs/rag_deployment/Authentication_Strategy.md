# v2 아키텍처: 인증 전략

이 문서는 Meta-RAG v2 아키텍처에서 사용되는 두 가지 종류의 인증 시스템, **사용자 인증**과 **서비스 간 인증**에 대해 v2 아키텍처의 관점에서 명확히 정의합니다.

## 1. 사용자 인증 (User Authentication)

이는 최종 사용자를 위한 '로그인 시스템'에 해당하며, **GCP API Gateway**가 그 책임을 전담합니다.

-   **인증 주체와 대상**: **최종 사용자**가 **백엔드 서비스(Cloud Run)**에 접근하기 전, **GCP API Gateway**에서 인증을 통과해야 합니다.

-   **필요성 (Why)**:
    -   **사용자 식별 및 개인화**: 사용자를 고유하게 식별하여 피드백 추적, 과거 이력 조회 등 개인화된 기능을 제공합니다.
    -   **API 남용 방지**: 인가된 사용자만 API를 호출하도록 제어하고, 사용자별 Rate Limiting을 적용하여 시스템을 보호합니다.

-   **구현 방법 (How)**:
    1.  **토큰 발급**: 사용자가 클라이언트 앱에서 로그인하면, 별도의 인증 서버(직접 구축 또는 Firebase Authentication 등 외부 서비스 사용)로부터 **JWT(JSON Web Token)**를 발급받습니다.
    2.  **토큰 제출**: 사용자는 API를 호출할 때마다 HTTP `Authorization: Bearer <TOKEN>` 헤더에 이 JWT를 포함하여 보냅니다.
    3.  **게이트웨이에서 검증**: **GCP API Gateway**는 백엔드로 요청을 전달하기 전에, 이 토큰의 서명과 만료 시간을 검증합니다. OpenAPI 명세서에 정의된 `securitySchemes` 설정을 통해 이 과정을 자동화할 수 있습니다.
    4.  **백엔드로 전달**: 유효한 토큰을 가진 요청만이 백엔드(Cloud Run)로 전달됩니다. 백엔드는 전달된 JWT의 payload를 읽어 `user_id`, `tier` 등 비즈니스 로직 처리에 필요한 사용자 정보를 얻을 수 있습니다.

---

## 2. 서비스 간 인증 (Service-to-Service Authentication)

이는 시스템 내부 컴포넌트 간의 '신원 확인' 절차에 해당하며, **GCP IAM**을 통해 구현됩니다.

-   **인증 주체와 대상**: **오케스트레이터(Cloud Run)**가 **내부 ML 서비스(Vertex AI Endpoint 등)**에 접근할 때 필요합니다.

-   **필요성 (Why)**:
    -   **내부 자원 보호**: 고비용의 ML 자원이 인터넷에 노출되는 것을 막고, 오직 인가된 내부 서비스만이 호출할 수 있도록 엄격히 보호합니다.
    -   **제로 트러스트(Zero Trust) 보안 원칙**: 내부 통신이라 할지라도 서로를 신뢰하지 않고, 모든 서비스가 다른 서비스를 호출할 때 자신의 신원을 증명하도록 합니다.

-   **구현 방법 (How)**:
    -   **GCP IAM 및 서비스 계정(Service Account)**: GCP 환경에서 서비스 간 인증을 구현하는 가장 안전하고 표준적인 방법입니다.
        1.  **서비스 계정 생성 및 연결**: Cloud Run 서비스가 실행될 고유한 **서비스 계정**을 생성하고, Cloud Run 서비스에 연결합니다.
        2.  **권한 부여**: Vertex AI 엔드포인트의 IAM 정책에서, 위에서 생성한 특정 서비스 계정 ID를 가진 주체(`principal`)만이 해당 엔드포인트를 호출(`invoke`)할 수 있도록 권한을 부여합니다.
        3.  **자동 인증**: Cloud Run이 Vertex AI를 호출하면, GCP 인프라는 이 호출이 허가된 서비스 계정으로부터 온 것임을 자동으로 확인하고 요청을 처리합니다. 개발자가 코드에 직접 API 키나 비밀번호를 하드코딩할 필요가 없습니다.